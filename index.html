<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor PGN — sube tu partida + análisis</title>

<style>
  :root{
    --bg:#0b1220; --panel:#0f1b2e; --borde:#232a36; --txt:#e6edf3; --muted:#9fb0c3;
    --square-a:#f0d9b5; --square-b:#b58863; --btn:#24324a; --btnbd:#3b4a63; --btnh:#2f456a; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  h1{max-width:1120px;margin:18px auto 8px;padding:0 16px;font-size:26px}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--borde);border-radius:14px;padding:12px}

  /* tablero canvas */
  #canvasBox{width:100%;max-width:560px;margin:auto}
  canvas{width:100%;height:auto;display:block;border:1px solid var(--borde);border-radius:10px;background:transparent}

  /* controles */
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--btn);border:1px solid var(--btnbd);color:var(--txt);border-radius:10px;padding:10px 14px;cursor:pointer}
  button:hover{background:var(--btnh)}
  .primary{background:#2f7d4e;border-color:#2f7d4e}
  input,textarea{font:inherit}
  input[type="number"]{width:100px;background:#0b1627;border:1px solid var(--borde);border-radius:8px;padding:8px;color:var(--txt)}
  textarea{width:100%;min-height:220px;background:#0b1627;border:1px solid var(--borde);border-radius:10px;padding:10px;color:var(--txt);resize:vertical;white-space:pre-wrap}
  .box{background:#0b1627;border:1px solid var(--borde);border-radius:10px;padding:10px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap}
  .note{color:var(--muted);font-size:14px}
  .ok{color:var(--ok)}
</style>

<!-- Reglas y PGN (chess.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
</head>
<body>
  <h1>Visor PGN — sube tu partida + análisis</h1>

  <div class="wrap grid">
    <!-- IZQUIERDA: tablero + controles -->
    <div class="panel">
      <div id="canvasBox">
        <canvas id="board" width="560" height="560" aria-label="Tablero de ajedrez"></canvas>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="prevBtn">← Anterior</button>
        <button id="playBtn" class="primary">▶ Play</button>
        <button id="nextBtn">Siguiente →</button>
        <button id="resetBtn">Reiniciar</button>
      </div>

      <div class="row" style="margin-top:8px">
        <label>Velocidad (ms) <input id="speed" type="number" value="800" min="100" step="50"></label>
      </div>

      <div id="status" class="note ok" style="margin-top:8px">OK: tablero dibujado.</div>
    </div>

    <!-- DERECHA: cargar PGN + análisis -->
    <div class="panel">
      <div class="row">
        <input id="file" type="file" accept=".pgn,.txt">
        <button id="loadFileBtn" class="primary">Cargar PGN</button>
      </div>

      <div class="note" style="margin:8px 0 6px">O pega un PGN aquí:</div>
      <textarea id="pgnText">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0
      </textarea>

      <div class="row" style="margin-top:8px">
        <button id="loadTextBtn" class="primary">Cargar desde texto</button>
        <button id="copyFenBtn">Copiar FEN actual</button>
      </div>

      <div id="gameInfo" class="note" style="margin-top:10px">Sin partida cargada.</div>
      <div id="movesBox" class="box mono" style="margin-top:6px">Movidas aparecerán aquí…</div>

      <div class="note" style="margin-top:12px">Análisis con Stockfish</div>
      <div class="row" style="margin-top:6px">
        <button id="analyzeBtn" class="primary">Analizar posición</button>
        <button id="stopBtn">Detener</button>
      </div>

      <div class="row" style="gap:16px;margin-top:8px">
        <label>Profundidad máx: <input id="maxDepth" type="number" min="6" max="30" value="18"></label>
        <label>N. líneas: <input id="multipv" type="number" min="1" max="3" value="1"></label>
      </div>

      <div class="box" id="evalBox" style="margin-top:8px">Eval: — &nbsp;&nbsp;|&nbsp;&nbsp; Profundidad: — &nbsp;&nbsp;|&nbsp;&nbsp; Mejor jugada: —</div>
      <div class="box mono" id="pvBox" style="margin-top:8px">Líneas de análisis aparecerán aquí…</div>
    </div>
  </div>

<script>
/* ===================== Tablero en canvas (sin libs visuales) ===================== */
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const SIZE = canvas.width;        // 560
const S = SIZE/8;
const COLORS = { light:getCss('--square-a'), dark:getCss('--square-b') };
const GLYPH = {'P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔','p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚'};

function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function drawBoard(fenPieces){
  // fondo casillas
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const light = (r+c)%2===0;
      ctx.fillStyle = light? COLORS.light : COLORS.dark;
      ctx.fillRect(c*S, r*S, S, S);
    }
  }
  // piezas unicode
  const rows = fenPieces.split('/');
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font = `${S*0.72}px "Segoe UI Symbol","Apple Color Emoji","Noto Color Emoji",serif`;
  for(let r=0;r<8;r++){
    let file=0;
    for(const ch of rows[r]){
      if(/\d/.test(ch)){ file += parseInt(ch,10); }
      else{
        const x=(file+0.5)*S, y=(r+0.5)*S;
        ctx.fillStyle = /[PRNBQK]/.test(ch)? '#ffffff' : '#111111';
        ctx.fillText(GLYPH[ch]||'', x, y);
        file++;
      }
    }
  }
}

/* ===================== Lógica PGN (chess.js) ===================== */
let game, frames=[], idx=0;

function initGame(){
  if(typeof Chess!=='function'){
    setStatus('No se pudo cargar chess.js (reglas). Revisa tu conexión.');
    return false;
  }
  game = new Chess();
  frames = [game.fen()];
  idx=0;
  render();
  return true;
}

function render(){
  const fenPieces = (frames[idx]||game.fen()).split(' ')[0];
  drawBoard(fenPieces);
  setStatus(`Posición ${idx}/${Math.max(frames.length-1,0)}`);
}

function setStatus(msg, isOk){
  const el = document.getElementById('status');
  el.textContent = msg;
  el.classList.toggle('ok', !!isOk);
}

function loadPGN(pgn){
  // Normaliza saltos de línea y elimina BOM invisibles
  pgn = (pgn||'').replace(/\r\n/g,'\n').replace(/^\uFEFF/,'').trim();
  if(!pgn){
    alert('PGN vacío.');
    return;
  }
  // Carga tolerante
  const ok = game.load_pgn(pgn, { sloppy:true });
  if(!ok){ alert('PGN inválido. Revisa el formato.'); return; }

  const san = game.history();      // SAN principal
  // reconstruir paso a paso
  game.reset();
  frames = [game.fen()];
  for(const mv of san){ game.move(mv); frames.push(game.fen()); }
  idx = 0;

  // Muestra SAN bonito con números de jugada
  const pretty = [];
  for(let i=0;i<san.length;i++){
    if(i%2===0) pretty.push(`${Math.floor(i/2)+1}. ${san[i]}`);
    else pretty.push(san[i]);
  }
  document.getElementById('movesBox').textContent = pretty.join(' ');
  document.getElementById('gameInfo').textContent = `Movidas: ${san.length}`;
  render();
}

/* ===================== Controles reproducción ===================== */
document.getElementById('prevBtn').onclick = ()=>{ if(idx>0){ idx--; render(); } };
document.getElementById('nextBtn').onclick = ()=>{ if(idx<frames.length-1){ idx++; render(); } };
document.getElementById('resetBtn').onclick = ()=>{ idx=0; render(); };

let timer=null;
document.getElementById('playBtn').onclick = ()=>{
  if(timer){ clearInterval(timer); timer=null; return; }
  const ms = Math.max(100, +document.getElementById('speed').value||800);
  timer = setInterval(()=>{ if(idx<frames.length-1){ idx++; render(); } else { clearInterval(timer); timer=null; } }, ms);
};

/* ===================== Cargar PGN (archivo / texto) ===================== */
document.getElementById('loadFileBtn').onclick = async ()=>{
  const f = document.getElementById('file').files?.[0];
  if(!f){ alert('Selecciona un archivo .pgn'); return; }
  try{
    const txt = await f.text();
    loadPGN(txt);
  }catch(e){
    alert('No se pudo leer el archivo.');
  }
};
document.getElementById('loadTextBtn').onclick = ()=>{
  loadPGN(document.getElementById('pgnText').value);
};
document.getElementById('copyFenBtn').onclick = async ()=>{
  const fen = frames[idx] || game.fen();
  try{
    await navigator.clipboard.writeText(fen);
    setStatus('FEN copiado.', true);
  }catch(e){
    setStatus('No se pudo copiar el FEN.');
  }
};

/* ===================== Stockfish con Worker-BLOB y mirrors ===================== */
let engine=null, engineReady=false;

const STOCKFISH_CANDIDATES = [
  // 1) CDNJS (recomendado y estable)
  'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/9.0.0/stockfish.js',
  // 2) jsDelivr versión directa (por si falla el 1)
  'https://cdn.jsdelivr.net/gh/niklasf/stockfish.js/stockfish.js',
  // 3) LOCAL opcional: súbelo como /engine/stockfish.js (mismo repo/GitHub Pages)
  location.origin + '/engine/stockfish.js'
];

async function getFirstWorkingEngineURL(){
  for(const url of STOCKFISH_CANDIDATES){
    const ok = await tryCreateWorker(url);
    if(ok) return url;
  }
  return null;
}

function tryCreateWorker(url){
  return new Promise(resolve=>{
    // Creamos un Worker desde un BLOB que hace importScripts(url)
    const code = `
      self.onerror = function(e){ postMessage({type:'sf-error', msg:String(e&&e.message||e)}); };
      try { importScripts('${url}'); } catch(e){ postMessage({type:'sf-error', msg:String(e)}); }
      // Stockfish (JS/ASM/WASM) se adjunta a self.onmessage; respondemos a un 'uci' con 'uciok'
      // En la mayoría de builds, el engine ya define su onmessage y enviará 'uciok' al pedirlo.
    `;
    const blobURL = URL.createObjectURL(new Blob([code], {type:'application/javascript'}));
    let w;
    try{ w = new Worker(blobURL); }catch(e){ resolve(false); return; }

    let settled = false;
    const timer = setTimeout(()=>{ if(!settled){ settled=true; w.terminate(); resolve(false); } }, 4000);

    w.onmessage = (e)=>{
      const line = (typeof e.data==='string') ? e.data : (e.data?.data||'');
      if(line && /uciok/.test(line)){
        clearTimeout(timer); settled=true; w.terminate(); resolve(true);
      }
    };
    // Intenta pedir UCI para provocar 'uciok'
    w.postMessage && w.postMessage('uci');
  });
}

let chosenURL = null;

async function ensureEngine(){
  if(engine) return engine;
  document.getElementById('evalBox').textContent = 'Cargando motor…';
  chosenURL = await getFirstWorkingEngineURL();
  if(!chosenURL){
    document.getElementById('evalBox').textContent = 'No se pudo cargar Stockfish (todos los mirrors fallaron).';
    return null;
  }
  const code = `
    self.onerror = function(e){ postMessage({type:'sf-error', msg:String(e&&e.message||e)}); };
    try { importScripts('${chosenURL}'); } catch(e){ postMessage({type:'sf-error', msg:String(e)}); }
  `;
  const url = URL.createObjectURL(new Blob([code], {type:'application/javascript'}));
  try{
    engine = new Worker(url);
  }catch(e){
    document.getElementById('evalBox').textContent = 'No se pudo crear el Worker del motor.';
    return null;
  }
  engine.onmessage = (e)=>{
    const line = (typeof e.data==='string') ? e.data : (e.data?.data||'');
    if(!line) return;
    if(line.startsWith('info ')){
      const depth = (line.match(/\bdepth\s+(\d+)/)||[])[1] || '—';
      const cp    = (line.match(/\bcp\s+(-?\d+)/)||[])[1];
      const mate  = (line.match(/\bmate\s+(-?\d+)/)||[])[1];
      const pv    = (line.match(/\bpv\s+(.+)/)||[])[1] || '';
      const evalTxt = mate ? ('#'+mate) : (cp? (Number(cp)/100).toFixed(2) : '—');
      document.getElementById('evalBox').textContent =
        `Eval: ${evalTxt}  |  Profundidad: ${depth}  |  Mejor jugada: ${(pv.split(' ')[0]||'—')}`;
      document.getElementById('pvBox').textContent = pv;
    }
    if(/uciok/.test(line)){ engineReady = true; }
  };
  // Inicializa
  engine.postMessage('uci');
  return engine;
}

document.getElementById('analyzeBtn').onclick = async ()=>{
  const e = await ensureEngine();
  if(!e) return;
  const depth = Math.max(6, Math.min(30, +document.getElementById('maxDepth').value||18));
  const multi = Math.max(1, Math.min(3, +document.getElementById('multipv').value||1));
  const fen   = frames[idx] || game.fen();
  document.getElementById('evalBox').textContent = `Motor: ${chosenURL} | Analizando…`;
  document.getElementById('pvBox').textContent   = 'Pensando…';
  e.postMessage('setoption name MultiPV value '+multi);
  e.postMessage('isready');
  e.postMessage('ucinewgame');
  e.postMessage('position fen '+fen);
  e.postMessage('go depth '+depth);
};
document.getElementById('stopBtn').onclick = ()=>{ if(engine) engine.postMessage('stop'); };

/* ===================== Inicialización ===================== */
window.addEventListener('load', ()=>{
  if(initGame()){
    render();
    setStatus('OK: tablero dibujado.', true);
  }
});
</script>
</body>
</html>
