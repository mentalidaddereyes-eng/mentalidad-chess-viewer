<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor PGN + análisis</title>

<!-- Estilos mínimos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.css">
<style>
  body{background:#0b1220;color:#e6eef3;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  h1{margin:8px 0 16px;font-size:28px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{background:#101522;border:1px solid #232a36;border-radius:12px;padding:12px}
  #board{max-width:520px;margin:auto}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{background:#1e824c;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.sec{background:#283246}
  input,textarea{width:100%;background:#0b1220;border:1px solid #232a36;color:#e6eef3;border-radius:10px;padding:10px}
  textarea{min-height:220px;white-space:pre-wrap}
  .kpi{display:grid;grid-template-columns:1fr 1fr 2fr;gap:8px;margin-top:8px}
  .box{background:#0b1220;border:1px solid #232a36;border-radius:10px;padding:10px}
  .note{opacity:.8;font-size:13px;margin-top:6px}
  .moves{min-height:58px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Visor PGN — sube tu partida + análisis</h1>

  <div class="grid">
    <!-- TABLERO -->
    <div class="panel">
      <div id="board"></div>
      <div class="row">
        <button id="prevBtn" class="sec">← Anterior</button>
        <button id="playBtn">▶ Play</button>
        <button id="nextBtn" class="sec">Siguiente →</button>
        <button id="resetBtn" class="sec">Reiniciar</button>
      </div>
      <div class="row" style="justify-content:flex-start">
        <label>Velocidad (ms)&nbsp;<input id="speed" type="number" value="800" style="width:120px"></label>
      </div>
      <div class="note" id="status">OK: tablero dibujado.</div>
    </div>

    <!-- PANEL DERECHA -->
    <div class="panel">
      <div class="row" style="justify-content:flex-start">
        <input id="pgnFile" type="file" accept=".pgn,.txt" style="max-width:280px">
        <button id="loadFileBtn">Cargar PGN</button>
      </div>

      <textarea id="pgnText">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0</textarea>

      <div class="row">
        <button id="loadTextBtn">Cargar desde texto</button>
        <button id="copyFenBtn" class="sec">Copiar FEN actual</button>
      </div>

      <div class="box moves" id="movesBox">Movidas aparecerán aquí…</div>

      <div class="row" style="justify-content:flex-start;margin-top:12px">
        <button id="analyseBtn">Analizar posición</button>
        <button id="stopBtn" class="sec">Detener</button>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="note">Profundidad máx:</div>
          <input id="maxDepth" type="number" min="6" max="30" value="18">
        </div>
        <div class="box">
          <div class="note">N. líneas:</div>
          <input id="multipv" type="number" min="1" max="3" value="1">
        </div>
        <div class="box" id="evalBox">Eval: — &nbsp;&nbsp; Profundidad: — &nbsp;&nbsp; Mejor jugada: —</div>
      </div>

      <div class="box note" style="margin-top:8px">
        Si “Analizar posición” muestra error de motor, verifica conectividad a CDN.
      </div>
    </div>
  </div>
</div>

<!-- Librerías: chess.js y chessboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.js"></script>

<script>
/* ========= Estado global ========= */
const game = new Chess();
let board, timer=null, playing=false;
let mainline = [];  // lista de FEN después de cada jugada (incluye posición inicial)

/* ========= Tablero ========= */
function drawBoard() {
  board = Chessboard('board', {
    position: game.fen(),
    draggable: false,
    pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/img/chesspieces/wikipedia/{piece}.png'
  });
  window.addEventListener('resize', board.resize);
}
drawBoard();

/* ========= Utilidades ========= */
function showStatus(msg){ document.getElementById('status').textContent = msg; }
function showMoves(list){ document.getElementById('movesBox').textContent = list.join(' '); }
function rebuildMainline() {
  // Genera FEN por cada jugada de la línea principal
  const tmp = new Chess();
  mainline = [tmp.fen()];
  const moves = game.history({verbose:true});
  const shown = [];
  moves.forEach((m, i) => {
    tmp.move(m);
    mainline.push(tmp.fen());
    const san = tmp.undo(), sanText = game.history()[i]; // usamos SAN original
    tmp.move(m);
    shown.push((i%2===0 ? (Math.floor(i/2)+1)+'. ' : '') + sanText);
  });
  showMoves(shown);
}
function resetTo(i=0){
  game.reset();
  const tmp = new Chess();
  for (let k=1; k<=i && k<mainline.length; k++){
    tmp.load(mainline[k]);
  }
  game.load(tmp.fen());
  board.position(game.fen());
}

/* ========= Controles ========= */
document.getElementById('prevBtn').onclick = ()=>{
  const i = Math.max(0, mainline.indexOf(game.fen()) - 1);
  game.load(mainline[i]); board.position(game.fen());
};
document.getElementById('nextBtn').onclick = ()=>{
  const i = Math.min(mainline.length-1, mainline.indexOf(game.fen()) + 1);
  game.load(mainline[i]); board.position(game.fen());
};
document.getElementById('resetBtn').onclick = ()=>{ resetTo(0); };

document.getElementById('playBtn').onclick = ()=>{
  if (playing){ clearInterval(timer); playing=false; return; }
  const speed = Math.max(200, Number(document.getElementById('speed').value)||800);
  let i = mainline.indexOf(game.fen());
  timer = setInterval(()=>{
    i = (i+1) % mainline.length;
    game.load(mainline[i]); board.position(game.fen());
  }, speed);
  playing = true;
};

/* ========= Cargar PGN ========= */
function parsePGN(pgnText){
  game.reset();
  const ok = game.load_pgn(pgnText, {sloppy:true});
  if(!ok){ alert('PGN inválido'); return; }
  board.position(game.fen());
  rebuildMainline();
  showStatus('PGN cargado.');
}

document.getElementById('loadTextBtn').onclick = ()=>{
  parsePGN(document.getElementById('pgnText').value);
};
document.getElementById('loadFileBtn').onclick = async ()=>{
  const f = document.getElementById('pgnFile').files[0];
  if(!f){ alert('Elige un archivo PGN.'); return; }
  const txt = await f.text();
  parsePGN(txt);
};
document.getElementById('copyFenBtn').onclick = async ()=>{
  await navigator.clipboard.writeText(game.fen());
  showStatus('FEN copiado al portapapeles.');
};

/* ========= Stockfish por CDN (Worker clásico) ========= */
let engine = null, analyzing = false;

// CDN oficial (jsDelivr o unpkg). Usa el que prefieras:
const STOCKFISH_CDN = 'https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.js';
// const STOCKFISH_CDN = 'https://unpkg.com/stockfish@16/stockfish.js';

function initEngine(){
  try{
    engine = new Worker(STOCKFISH_CDN);
    engine.onmessage = (e)=>{
      const line = (typeof e.data==='string') ? e.data : (e.data?.data||'');
      if(line.startsWith('info')){
        const depth = (line.match(/\bdepth\s+(\d+)/)||[])[1];
        const cp    = (line.match(/\bcp\s+(-?\d+)/)||[])[1];
        const mate  = (line.match(/\bmate\s+(-?\d+)/)||[])[1];
        const pv    = (line.match(/\bpv\s+(.+)/)||[])[1];
        let evalTxt = '—';
        if(mate){ evalTxt = `#${mate}`; }
        else if(cp){ evalTxt = (Number(cp)/100).toFixed(2); }
        document.getElementById('evalBox').textContent =
          `Eval: ${evalTxt}   —   Profundidad: ${depth||'—'}   —   Mejor jugada: ${(pv||'').split(' ')[0]||'—'}`;
      } else if(line.startsWith('bestmove')){
        analyzing = false;
      }
    };
  }catch(err){
    alert('No se pudo cargar Stockfish.');
  }
}

// Botón Analizar
document.getElementById('analyseBtn').onclick = ()=>{
  if(!engine){ initEngine(); }
  if(!engine){ return; }

  const fen = game.fen();
  const depth = Math.max(6, Math.min(30, Number(document.getElementById('maxDepth').value)||18));
  const multi = Math.max(1, Math.min(3, Number(document.getElementById('multipv').value)||1));

  document.getElementById('evalBox').textContent = 'Analizando…';
  analyzing = true;

  engine.postMessage('uci');
  engine.postMessage('isready');
  engine.postMessage('ucinewgame');
  engine.postMessage(`position fen ${fen}`);
  engine.postMessage(`setoption name MultiPV value ${multi}`);
  engine.postMessage(`go depth ${depth}`);
};

document.getElementById('stopBtn').onclick = ()=>{
  if(engine) engine.postMessage('stop');
  analyzing = false;
};
</script>
</body>
</html>
