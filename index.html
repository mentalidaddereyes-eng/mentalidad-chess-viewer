<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor PGN — sube tu partida</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
  :root{--bg:#0b1220;--panel:#101a2b;--fg:#e6eef3;--mut:#9fb3c8;--acc:#2ea36a;--br:#232a36}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  h2{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--br);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:#243149;border:1px solid var(--br);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  button.green{background:var(--acc);border:none;color:#05160c}
  input[type="number"],textarea{background:#0f1626;color:var(--fg);border:1px solid var(--br);border-radius:10px;padding:8px}
  textarea{width:100%;min-height:180px;resize:vertical}
  .board{
  width:100%;
  max-width:560px;
  height:560px;                 /* <- altura fija para que se vea siempre */
  border:1px solid var(--br);
  border-radius:12px;
  overflow:hidden;
  user-select:none;
  position:relative;
}
.g{
  display:grid;
  grid-template-columns:repeat(8,1fr);
  grid-template-rows:repeat(8,1fr);
  width:100%;
  height:100%;                  /* <- asegura que la grilla ocupe todo */
}

  .sq{display:flex;align-items:center;justify-content:center;font-size:40px}
  .light{background:#f0d9b5}.dark{background:#b58863}
  .moves{height:200px;background:#0f1626;border:1px solid var(--br);border-radius:10px;padding:10px;overflow:auto;color:var(--mut)}
  .tag{display:inline-block;margin-right:6px;color:var(--mut)}
</style>
</head>
<body>
<div class="wrap">
  <h2>Visor PGN — sube tu partida</h2>

  <div class="grid">
    <div class="panel">
      <div id="board" class="board"><div class="g" id="grid"></div></div>
      <div class="row" style="margin-top:12px">
        <button id="prevBtn">← Anterior</button>
        <button id="playBtn">▶ Play</button>
        <button id="nextBtn">Siguiente →</button>
        <button id="resetBtn">Reiniciar</button>
        <span style="margin-left:auto">Velocidad (ms)</span>
        <input id="speed" type="number" value="800" min="100" step="50" style="width:90px">
      </div>
      <div id="status" class="tag" style="margin-top:8px">OK: tablero dibujado.</div>
    </div>

    <div class="panel">
      <div class="row">
        <input id="pgnFile" type="file" accept=".pgn">
        <button id="loadFileBtn" class="green">Cargar PGN</button>
      </div>
      <textarea id="pgnText" placeholder="O pega aquí el PGN...">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0
</textarea>
      <div class="row" style="margin-top:8px">
        <button id="loadTextBtn" class="green">Cargar desde texto</button>
        <button id="copyFenBtn">Copiar FEN actual</button>
      </div>
      <div style="margin-top:12px;font-weight:600">Movidas aparecerán aquí…</div>
      <div id="movesBox" class="moves"></div>
    </div>
  </div>
</div>

<!-- chess.js para parsear PGN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script>
/* === Tablero con Unicode === */
const UNI={P:'♙',N:'♘',B:'♗',R:'♖',Q:'♕',K:'♔',p:'♟',n:'♞',b:'♝',r:'♜',q:'♛',k:'♚'};
const grid=document.getElementById('grid');
function drawEmpty(){grid.innerHTML='';for(let r=7;r>=0;r--){for(let c=0;c<8;c++){const d=document.createElement('div');d.className='sq '+(((r+c)%2)?'dark':'light');grid.appendChild(d);}}}
function drawFEN(fen){drawEmpty();const [pp]=fen.split(' ');let r=7,c=0;for(const ch of pp){if(ch==='/'){r--;c=0;continue;} if(/[1-8]/.test(ch)){c+=+ch;continue;} const idx=(7-r)*8+c;grid.children[idx].textContent=UNI[ch]||'';c++;}}
function setStatus(t){document.getElementById('status').textContent=t;}

/* === Carga PGN robusta === */
let game=new Chess(); let frames=[game.fen()]; let ply=0; let timer=null;
function refresh(){drawFEN(frames[ply]);document.getElementById('movesBox').scrollTop=document.getElementById('movesBox').scrollHeight;}
function takeFirstGame(t){const s=t.indexOf('[Event');if(s===-1)return t;const rest=t.slice(s+6);const n=rest.indexOf('\n[Event');return n===-1?t.slice(s):t.slice(s,s+6+n);}
function clean(t){return t.replace(/\$[0-9]+/g,'').replace(/\[%... [^\]]*]/g,'').replace(/\{[^}]*\}/g,'').replace(/;.*$/gm,'');}
function rebuild(pgn){const ok=game.load_pgn(pgn,{sloppy:true}); if(!ok) return false; const tmp=new Chess(); frames=[tmp.fen()]; const moves=game.history({verbose:false}); const list=[]; for(let i=0;i<moves.length;i++){const san=moves[i]; if(!tmp.move(san,{sloppy:true})) return false; frames.push(tmp.fen()); const n=Math.floor(i/2)+1; if(i%2===0) list.push(`${n}. ${san}`); else list[list.length-1]+=` ${san}`;} document.getElementById('movesBox').innerHTML=list.map(x=>`<div>${x}</div>`).join(''); ply=0; setStatus(`Cargadas ${moves.length} jugadas.`); return true;}
async function readSmart(file){const buf=await file.arrayBuffer();const b=new Uint8Array(buf);const bom8=b.length>=3&&b[0]==0xEF&&b[1]==0xBB&&b[2]==0xBF;const bom16le=b.length>=2&&b[0]==0xFF&&b[1]==0xFE;const bom16be=b.length>=2&&b[0]==0xFE&&b[1]==0xFF;try{if(bom16le)return new TextDecoder('utf-16le').decode(b.subarray(2));if(bom16be)return new TextDecoder('utf-16be').decode(b.subarray(2));if(bom8)return new TextDecoder('utf-8').decode(b.subarray(3));const zeros=b.filter(x=>x===0).length;if(zeros>b.length*0.2){try{return new TextDecoder('utf-16le').decode(b);}catch{} try{return new TextDecoder('utf-16be').decode(b);}catch{}}try{return new TextDecoder('utf-8',{fatal:true}).decode(b);}catch{} return new TextDecoder('windows-1252').decode(b);}catch{return new TextDecoder().decode(b);}}

/* === Botones === */
document.getElementById('prevBtn').onclick=()=>{if(ply>0){ply--;refresh();}};
document.getElementById('nextBtn').onclick=()=>{if(ply<frames.length-1){ply++;refresh();}};
document.getElementById('playBtn').onclick=()=>{if(timer){clearInterval(timer);timer=null;setStatus('Pausa');return;}const sp=Math.max(100,Number(document.getElementById('speed').value)||800);timer=setInterval(()=>{if(ply<frames.length-1){ply++;refresh();}else{clearInterval(timer);timer=null;setStatus('Fin');}},sp);setStatus('Reproduciendo…');};
document.getElementById('resetBtn').onclick=()=>{if(timer){clearInterval(timer);timer=null;} ply=0;refresh();setStatus('Reiniciado');};
document.getElementById('copyFenBtn').onclick=()=>{navigator.clipboard.writeText(frames[ply]||'');setStatus('FEN copiado');};
document.getElementById('loadTextBtn').onclick=()=>{let t=document.getElementById('pgnText').value; t=t.replace(/^\uFEFF/,'').replace(/\r\n?/g,"\n"); t=takeFirstGame(t); if(!rebuild(t)){const c=clean(t); if(!rebuild(c)) return alert('PGN inválido.');} refresh();};
document.getElementById('loadFileBtn').onclick=async()=>{const f=document.getElementById('pgnFile').files?.[0]; if(!f) return alert('Selecciona un archivo .pgn'); let t=await readSmart(f); t=t.replace(/^\uFEFF/,'').replace(/\r\n?/g,"\n"); t=takeFirstGame(t); if(!rebuild(t)){const c=clean(t); if(!rebuild(c)) return alert('PGN inválido.');} refresh();};

/* === Inicio === */
drawEmpty(); frames=[game.fen()]; refresh(); setStatus('OK: tablero dibujado.');
</script>
</body>
</html>
