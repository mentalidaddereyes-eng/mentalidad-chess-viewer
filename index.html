<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visor PGN — simple</title>

<!-- Chessboard.js CSS (piezas incluidas) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css" />

<style>
  :root{
    --bg:#0b1220; --panel:#111a2b; --fg:#e6eef3; --mut:#9fb3c8; --acc:#29a36a; --br:#232a3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1120px;margin:auto;padding:16px}
  h1{font-size:28px;margin:8px 0 16px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--panel);border:1px solid var(--br);border-radius:12px;padding:12px}
  #board{width:100%;max-width:560px;aspect-ratio:1/1;border:1px solid var(--br);border-radius:12px;margin:auto}
  /* fallback por si aspect-ratio es ignorado */
  @supports not (aspect-ratio: 1/1){
    #board{height:560px}
  }

  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
  button{background:#20324d;border:1px solid var(--br);color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--acc);border-color:transparent;color:#08130d}
  input[type="number"], textarea{width:100%;background:#0e1728;border:1px solid var(--br);color:var(--fg);border-radius:10px;padding:10px}
  textarea{min-height:260px;white-space:pre}
  .mut{color:var(--mut);font-size:14px;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Visor PGN — sube tu partida</h1>

    <div class="grid">
      <!-- TABLERO / CONTROLES -->
      <div class="card">
        <div id="board"></div>

        <div class="row">
          <button id="prevBtn">← Anterior</button>
          <button id="playBtn" class="primary">▶ Play</button>
          <button id="nextBtn">Siguiente →</button>
          <button id="resetBtn">Reiniciar</button>
          <label style="margin-left:auto">Velocidad (ms)
            <input id="speed" type="number" min="100" step="100" value="800" style="width:110px">
          </label>
        </div>

        <div id="status" class="mut">Listo.</div>
      </div>

      <!-- PANEL PGN -->
      <div class="card">
        <div class="row">
          <input id="file" type="file" accept=".pgn" />
          <button id="loadFileBtn" class="primary">Cargar PGN</button>
        </div>

        <textarea id="pgnText">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0
</textarea>

        <div class="row">
          <button id="loadTextBtn" class="primary">Cargar desde texto</button>
          <button id="copyFENBtn">Copiar FEN actual</button>
        </div>

        <div class="mut">Consejo: también puedes pegar PGN reales; se limpiarán comentarios {…}, variantes (…) y NAGs $n.</div>
      </div>
    </div>
  </div>

  <!-- Librerías: chess.js (motor reglas) y chessboard.js (tablero) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
  (function(){
    // --- estado ---
    const game = new Chess();                // reglas y movimientos
    const board = Chessboard('board', 'start');
    let moves = [];                          // jugadas (verbose)
    let idx = 0;                             // índice actual
    let playing = false, timer = null;

    const $ = (sel)=>document.querySelector(sel);
    const status = $('#status');

    function setStatus(msg){ status.textContent = msg; }

    function render(){
      board.position(game.fen(), true);
    }

    function reset(){
      game.reset();
      idx = 0;
      render();
    }

    function next(){
      if (idx >= moves.length) return false;
      game.move(moves[idx++]);
      render();
      return true;
    }

    function prev(){
      if (idx <= 0) return;
      idx--;
      game.reset();
      for (let i=0;i<idx;i++) game.move(moves[i]);
      render();
    }

    function play(){
      if (playing) return;
      playing = true;
      const speed = Math.max(100, Number($('#speed').value)||800);
      timer = setInterval(()=>{
        if (!next()){
          stop();
        }
      }, speed);
    }

    function stop(){
      playing = false;
      if (timer){ clearInterval(timer); timer = null; }
    }

    function cleanPGN(txt){
      // quita comentarios {…}, variantes (…), NAGs $n y etiquetas [%…]
      return txt
        .replace(/\{[^}]*\}/g, ' ')
        .replace(/\([^()]*\)/g, ' ')
        .replace(/\$[0-9]+/g, ' ')
        .replace(/\[%[^\]]*]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function loadPGN(raw){
      const pgn = cleanPGN(raw);
      const ok = game.load_pgn(pgn, { sloppy: true });
      if (!ok){
        setStatus('PGN inválido.');
        alert('PGN inválido.');
        return;
      }
      // rehacer historia en verbose
      const hist = game.history({ verbose:true });
      game.reset();
      moves = hist;
      idx = 0;
      render();
      setStatus(`PGN cargado: ${moves.length} jugadas.`);
    }

    // --- eventos UI ---
    $('#loadTextBtn').onclick = ()=> loadPGN($('#pgnText').value);

    $('#loadFileBtn').onclick = async ()=>{
      const f = $('#file').files?.[0];
      if (!f){ alert('Selecciona un archivo .pgn'); return; }
      const txt = await f.text();
      loadPGN(txt);
    };

    $('#copyFENBtn').onclick = ()=>{
      navigator.clipboard.writeText(game.fen());
      setStatus('FEN copiada al portapapeles.');
    };

    $('#playBtn').onclick   = ()=> { stop(); play(); };
    $('#prevBtn').onclick   = ()=> { stop(); prev(); };
    $('#nextBtn').onclick   = ()=> { stop(); next(); };
    $('#resetBtn').onclick  = ()=> { stop(); reset(); };

    // dibuja tablero inicial
    render();
    setStatus('OK: tablero dibujado.');
  })();
  </script>
</body>
</html>
