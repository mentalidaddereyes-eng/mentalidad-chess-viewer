<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor PGN + análisis</title>

  <!-- Estilos mínimos -->
  <style>
    body{margin:0;background:#0b1220;color:#e6edf3;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    h2{margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:#101522;border:1px solid #232a36;border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{background:#1e8543;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#2b3241}
    input[type="number"],input[type="text"],textarea{
      width:100%;background:#0b1220;border:1px solid #232a36;border-radius:10px;
      color:#e6edf3;padding:10px
    }
    textarea{min-height:220px;white-space:pre-wrap}
    .log,.lines{background:#0b1220;border:1px solid #232a36;border-radius:10px;padding:10px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .hint{opacity:.75;font-size:.9rem}
    /* estilos locales mínimos para chessboard.js (evitamos <link>) */
    #board{max-width:520px;margin:auto}
    .board-72b1 { border:1px solid #232a36 }
    .square-55d63 { float:left; position:relative; width:12.5%; height:12.5% }
    .white-1e1d7 { background:#f0d9b5 } .black-3c85d { background:#b58863 }
    .highlight1-32417,.highlight2-9c5d2 { box-shadow: inset 0 0 0 4px rgba(255,235,59,.55) }
    .clearfix-7da63:after { content:""; display:block; clear:both }
  </style>

  <!-- Librerías desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <!-- Stockfish (asm.js/wasm) en web worker -->
  <script>
    const STOCKFISH_URL = 'https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.wasm.js';
  </script>
</head>
<body>
  <div class="wrap">
    <h2>Visor PGN — sube tu partida + análisis</h2>

    <div class="grid">
      <!-- TABLERO -->
      <div class="panel">
        <div id="board"></div>
        <div class="controls">
          <button id="prevBtn" class="secondary">← Anterior</button>
          <button id="playBtn">▶ Play</button>
          <button id="nextBtn" class="secondary">Siguiente →</button>
          <button id="resetBtn" class="secondary">Reiniciar</button>
        </div>
        <div class="controls">
          <span>Velocidad (ms)</span>
          <input id="speed" type="number" value="800" style="width:120px" />
        </div>
        <p class="hint" id="statusHint">OK: tablero dibujado.</p>
      </div>

      <!-- CARGA + ANÁLISIS -->
      <div class="panel">
        <div class="row">
          <input id="file" type="file" accept=".pgn,text/plain" />
          <button id="loadFileBtn">Cargar PGN</button>
        </div>

        <textarea id="pgnText">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0
</textarea>
        <div class="row" style="margin-top:8px">
          <button id="loadTextBtn">Cargar desde texto</button>
          <button id="copyFenBtn" class="secondary">Copiar FEN actual</button>
        </div>

        <p class="hint" id="gameHint">Sin partida cargada.</p>
        <div class="log" id="movesLog">Movidas aparecerán aquí…</div>

        <div class="row" style="margin-top:12px">
          <button id="analyzeBtn">Analizar posición</button>
          <button id="stopBtn" class="secondary">Detener</button>
        </div>

        <div class="row" style="gap:12px">
          <div>
            <div class="hint">Profundidad máx:</div>
            <input id="maxDepth" type="number" value="18" min="6" max="30" />
          </div>
          <div>
            <div class="hint">N. líneas:</div>
            <input id="multipv" type="number" value="1" min="1" max="3" />
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:8px">
          <div class="hint">Eval: <span id="eval">—</span></div>
          <div class="hint">Profundidad: <span id="depth">—</span></div>
          <div class="hint">Mejor jugada: <span id="best">—</span></div>
        </div>

        <div class="lines" id="linesBox">Líneas de análisis aparecerán aquí…</div>
      </div>
    </div>
  </div>

  <script>
    // --- Estado principal ---
    const game = new Chess();
    let board = null;
    let mainline = [];     // jugadas principales (obj de chess.js)
    let curr = 0;          // índice de jugada actual
    let timer = null;      // para el "play"
    let engine = null;     // worker de stockfish
    let engineReady = false;
    let analyzing = false;

    const $ = id => document.getElementById(id);

    function drawBoard() {
      board = Chessboard('board', {
        draggable: false,
        position: 'start',
        moveSpeed: 200
      });
      $('statusHint').textContent = 'OK: tablero dibujado.';
    }

    function refreshBoardToPly(ply) {
      const tmp = new Chess();
      for (let i = 0; i < ply && i < mainline.length; i++) tmp.move(mainline[i]);
      board.position(tmp.fen());
      $('copyFenBtn').onclick = () => {
        navigator.clipboard.writeText(tmp.fen());
      };
    }

    function parsePGN(pgn) {
      // limpiar e intentar cargar
      game.reset();
      if (!game.load_pgn(pgn)) {
        alert('PGN inválido.');
        return false;
      }
      // obtener jugadas de la línea principal
      mainline = game.history({ verbose:true });
      curr = 0;
      refreshBoardToPly(0);
      $('movesLog').textContent = game.pgn();
      $('gameHint').textContent = `Partida cargada. Total jugadas: ${mainline.length}`;
      return true;
    }

    // --- Botones de navegación ---
    $('prevBtn').onclick = () => {
      curr = Math.max(0, curr - 1);
      refreshBoardToPly(curr);
    };
    $('nextBtn').onclick = () => {
      curr = Math.min(mainline.length, curr + 1);
      refreshBoardToPly(curr);
    };
    $('resetBtn').onclick = () => { curr = 0; refreshBoardToPly(0); };

    $('playBtn').onclick = () => {
      if (timer) { clearInterval(timer); timer = null; $('playBtn').textContent = '▶ Play'; return; }
      const speed = Math.max(200, Number($('speed').value)||800);
      $('playBtn').textContent = '⏸ Pausa';
      timer = setInterval(() => {
        if (curr >= mainline.length) { clearInterval(timer); timer = null; $('playBtn').textContent = '▶ Play'; return; }
        curr++; refreshBoardToPly(curr);
      }, speed);
    };

    // --- Carga desde archivo ---
    $('loadFileBtn').onclick = async () => {
      const f = $('file').files?.[0];
      if (!f) { alert('Elige un archivo PGN.'); return; }
      const text = await f.text();
      parsePGN(text);
    };

    // --- Carga desde textarea ---
    $('loadTextBtn').onclick = () => {
      parsePGN($('pgnText').value);
    };

    // --- Stockfish ---
    function initEngine() {
      try {
        engine = new Worker(engine = new Worker('https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.js');
);
        engine.onmessage = (e) => {
          const line = (typeof e.data === 'string') ? e.data : (e.data?.data||'');
          // consola/diagnóstico
          if (line.startsWith('Stockfish')) engineReady = true;
          if (line.startsWith('info')) {
            const depth = /depth (\d+)/.exec(line)?.[1];
            const scoreMatch = /score (cp|mate) (-?\d+)/.exec(line);
            const best = / pv ([a-h][1-8][a-h][1-8][qrbn]?)/.exec(line)?.[1];
            if (depth) $('depth').textContent = depth;

            if (scoreMatch) {
              if (scoreMatch[1]==='cp') {
                const pawns = (Number(scoreMatch[2]) / 100).toFixed(2);
                $('eval').textContent = pawns;
              } else {
                $('eval').textContent = `Mate ${scoreMatch[2]}`;
              }
            }
            if (best) $('best').textContent = best;
          }
          if (line.startsWith('bestmove')) {
            analyzing = false;
          }
          if (line.includes('NNUE evaluation')) engineReady = true;
        };
        // activar
        engine.postMessage('uci');
        engine.postMessage('isready');
      } catch (err) {
        console.error(err);
        alert('No se pudo cargar Stockfish.');
      }
    }

    $('analyzeBtn').onclick = () => {
      if (!engine) initEngine();
      if (!engine) return;
      if (!engineReady) { alert('Motor iniciando… vuelve a intentar en 2s.'); return; }

      // FEN actual
      const tmp = new Chess();
      for (let i = 0; i < curr && i < mainline.length; i++) tmp.move(mainline[i]);

      const fen = tmp.fen();
      const depth = Math.max(6, Math.min(30, Number($('maxDepth').value)||18));
      const multi = Math.max(1, Math.min(3, Number($('multipv').value)||1));
      $('linesBox').textContent = 'Analizando…';
      analyzing = true;

      engine.postMessage('uci');
      engine.postMessage('isready');
      engine.postMessage('ucinewgame');
      engine.postMessage(`position fen ${fen}`);
      engine.postMessage(`setoption name MultiPV value ${multi}`);
      engine.postMessage(`go depth ${depth}`);
    };

    $('stopBtn').onclick = () => {
      if (engine) engine.postMessage('stop');
      analyzing = false;
    };

    // Inicializar tablero al cargar
    window.addEventListener('load', drawBoard);
  </script>
</body>
</html>
