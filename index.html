<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor PGN — reproducción básica</title>
<style>
  body{margin:0;background:#0b1220;color:#e6edf3;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{background:#101522;border:1px solid #232a36;border-radius:12px;padding:12px}
  #board{width:100%;max-width:520px;height:auto;display:block;margin:12px auto;border:1px solid #232a36;border-radius:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
  button{background:#2f7d4e;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#283246}
  input[type="number"]{width:100px;background:#0b1627;border:1px solid #232a36;border-radius:8px;padding:8px;color:#e6edf3}
  textarea{width:100%;min-height:200px;background:#0b1627;border:1px solid #232a36;border-radius:10px;padding:10px;color:#e6edf3;white-space:pre-wrap}
  .box{background:#0b1627;border:1px solid #232a36;border-radius:10px;padding:10px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap}
  .note{opacity:.85}
</style>
<!-- Reglas de ajedrez / PGN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Visor PGN — reproducción básica</h1>

  <div class="grid">
    <!-- Tablero + controles -->
    <div class="panel">
      <canvas id="board" width="520" height="520"></canvas>

      <div class="row" style="margin-top:12px">
        <button id="prevBtn" class="secondary">← Anterior</button>
        <button id="playBtn">▶ Play</button>
        <button id="nextBtn" class="secondary">Siguiente →</button>
        <button id="resetBtn" class="secondary">Reiniciar</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label>Velocidad (ms)&nbsp;<input id="speed" type="number" value="800" min="100" step="50"></label>
        <button id="copyFenBtn" class="secondary">Copiar FEN actual</button>
      </div>

      <p id="status" class="note">OK: tablero dibujado.</p>
    </div>

    <!-- Carga PGN -->
    <div class="panel">
      <div class="row" style="justify-content:flex-start">
        <input id="pgnFile" type="file" accept=".pgn,.txt" />
        <button id="loadFileBtn">Cargar PGN</button>
      </div>

      <p class="note" style="margin:8px 0 6px">O pega un PGN y pulsa “Cargar desde texto”:</p>
      <textarea id="pgnText">[Event "Mini"]
[Site "-"]
[Date "2024.09.28"]
[Round "-"]
[White "Blancas"]
[Black "Negras"]
[Result "1-0"]

1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6 4. Qxf7# 1-0</textarea>

      <div class="row" style="justify-content:flex-start;margin-top:8px">
        <button id="loadTextBtn">Cargar desde texto</button>
      </div>

      <div id="movesBox" class="box mono" style="margin-top:8px">Movidas aparecerán aquí…</div>
    </div>
  </div>
</div>

<script>
/* ===== Tablero en canvas (sin librerías visuales) ===== */
const cv = document.getElementById('board');
const cx = cv.getContext('2d');
const S = cv.width/8;
const LIGHT = '#f0d9b5', DARK = '#b58863';
const GL = {'P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔','p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚'};

function drawSquares(){
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      cx.fillStyle = ((r+c)%2===0)? LIGHT : DARK;
      cx.fillRect(c*S, r*S, S, S);
    }
  }
}
function drawPiecesFromFEN(fenPieces){
  const rows = fenPieces.split('/');
  cx.textAlign='center'; cx.textBaseline='middle'; cx.font = '44px "Segoe UI Symbol","Noto Color Emoji",serif';
  for(let r=0;r<8;r++){
    let f=0;
    for(const ch of rows[r]){
      if(/\d/.test(ch)){ f += +ch; }
      else{
        const x=(f+0.5)*S, y=(r+0.5)*S;
        cx.fillStyle = /[PRNBQK]/.test(ch)? '#111' : '#fff';
        cx.fillText(GL[ch]||'', x, y);
        f++;
      }
    }
  }
}
function renderFEN(fen){
  const fenPieces = fen.split(' ')[0];
  drawSquares(); drawPiecesFromFEN(fenPieces);
}

/* ===== Lógica PGN (chess.js) ===== */
const game = new Chess();
let frames = [game.fen()]; // FEN por cada paso (incluye inicio)
let idx = 0;               // índice actual
let timer = null;

function rebuildFramesFromPGN(pgn){
  game.reset();
  const ok = game.load_pgn(pgn, { sloppy:true });
  if(!ok){ alert('PGN inválido.'); return false; }
  const san = game.history(); // SAN principal
  // construir FEN paso a paso
  game.reset();
  frames = [game.fen()];
  for(const mv of san){ game.move(mv); frames.push(game.fen()); }
  idx = 0;
  // mostrar movidas
  const pretty = san.map((m,i)=> (i%2===0? (Math.floor(i/2)+1)+'. ':'')+m).join(' ');
  document.getElementById('movesBox').textContent = pretty || '—';
  setStatus(`PGN cargado. Total jugadas: ${san.length}`);
  return true;
}

function setStatus(t){ document.getElementById('status').textContent = t; }
function refresh(){ renderFEN(frames[idx]); setStatus(`Posición ${idx}/${frames.length-1}`); }

/* ===== Controles ===== */
document.getElementById('prevBtn').onclick = ()=>{ if(idx>0){ idx--; refresh(); } };
document.getElementById('nextBtn').onclick = ()=>{ if(idx<frames.length-1){ idx++; refresh(); } };
document.getElementById('resetBtn').onclick = ()=>{ idx=0; refresh(); };
document.getElementById('playBtn').onclick = ()=>{
  if(timer){ clearInterval(timer); timer=null; return; }
  const ms = Math.max(100, +document.getElementById('speed').value||800);
  timer = setInterval(()=>{ if(idx<frames.length-1){ idx++; refresh(); } else { clearInterval(timer); timer=null; } }, ms);
};
document.getElementById('copyFenBtn').onclick = async ()=>{
  await navigator.clipboard.writeText(frames[idx]);
  setStatus('FEN copiado.');
};

/* ===== Carga PGN ===== */
document.getElementById('loadTextBtn').onclick = ()=>{
  rebuildFramesFromPGN(document.getElementById('pgnText').value) && refresh();
};
document.getElementById('loadFileBtn').onclick = async ()=>{
  const f = document.getElementById('pgnFile').files?.[0];
  if(!f){ alert('Selecciona un archivo .pgn'); return; }
  const txt = await f.text();
  rebuildFramesFromPGN(txt) && refresh();
};

/* inicio: dibuja tablero inicial */
drawSquares();
(function putStart(){
  const rows = ['rnbqkbnr','pppppppp','8','8','8','8','PPPPPPPP','RNBQKBNR'];
  cx.textAlign='center'; cx.textBaseline='middle'; cx.font='44px "Segoe UI Symbol","Noto Color Emoji",serif';
  for(let r=0;r<8;r++){
    let f=0;
    for(const ch of rows[r]){
      if(/\d/.test(ch)){ f+=+ch; }
      else{ cx.fillStyle=/[PRNBQK]/.test(ch)?'#111':'#fff'; cx.fillText(GL[ch], (f+0.5)*S,(r+0.5)*S); f++; }
    }
  }
})();
setStatus('OK: tablero dibujado.');
</script>
</body>
</html>
