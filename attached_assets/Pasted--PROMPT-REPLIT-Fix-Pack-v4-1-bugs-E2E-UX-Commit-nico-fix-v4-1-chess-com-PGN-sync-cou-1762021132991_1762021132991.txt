üîß PROMPT REPLIT ‚Äî Fix Pack v4.1 (bugs E2E + UX)

Commit √∫nico: fix: v4.1 chess.com+ ‚Äî PGN sync, counter, play-vs-coach start, a11y, TTS single-channel, mobile dock

üéØ Objetivo

Cerrar todos los bugs reportados:

PGN: tablero no se actualiza / contador ‚Äú0/0‚Äù / navegaci√≥n bloqueada.

Play vs Coach: al jugar Negras, IA no arranca con Blancas.

Selector de color: dif√≠cil de testear (a11y/Playwright).

Scroll: exceso en algunas vistas.

Voz: evitar superposiciones (un solo canal).

1) PGN: sincronizaci√≥n tablero + navegaci√≥n + contador

Al importar PGN:

Reconstruir moveHistory y setear currentMove = last index (mostrar posici√≥n final).

Render del tablero ligado a currentMove (no al ‚ÄúexploratoryMoves‚Äù).

Habilitar ‚èÆ ‚è™ ‚ñ∂ ‚è© ‚è≠ seg√∫n currentMove y longitud real.

Contador:

UI debe mostrar full moves (ej.: ‚Äú3/3‚Äù para 1.e4 e5 2.Nf3 Nc6 3.Bb5).

C√°lculo: fullMoves = Math.ceil(halfMoves/2).

Ajustar MoveControls para no usar exploratoryMoves.length.

QA: cargar PGN de ejemplo y verificar:

Tablero en √∫ltima posici√≥n al cargar.

Contador en full moves.

Botones de navegaci√≥n activos.

2) Play vs Coach: arranque correcto + AutoFlip

Si mode = play-vs-coach y userSide = 'b', al iniciar partida:

AutoFlip a negras.

Llamar a /api/stockfish/analyze con FEN inicial (depth por defecto).

Aplicar bestMove de Blancas y explicar (texto + voz si üéôÔ∏è activo).

Manejo de errores:

Timeout 3‚Äì5s con retry x1; si falla, mostrar aviso y permitir ‚ÄúReintentar‚Äù.

QA: E2E debe ver primer movimiento de IA como Blancas y actualizaci√≥n de contador/tablero.

3) Selector de color (a11y + testability)

Reemplazar (o envolver) el Select de Radix por <select> nativa para E2E, o exponer fallback accesible.

A√±adir data-testid="play-color-select" y opciones con value w/b.

Bot√≥n ‚ÄúPlay vs Coach‚Äù con data-testid="btn-play-vs-coach".

4) Anti-scroll (desktop y m√≥vil)

Regla: tablero + botonera compacta visibles sin scroll en m√≥vil est√°ndar (390√ó844).

La p√°gina puede scrollear si es necesario, pero:

#analysisTab, #movesTab, #pgnBrowser ‚Üí max-height: 40vh; overflow:auto;

Evitar m√°rgenes/padding grandes bajo el tablero: botonera ‚â§ 40px alto, gap ‚â§ 6px, mt ‚â§ 6px.

Revisar MobileDock: que no tape el tablero ni obligue scroll extra.

5) Voz: canal √∫nico + debounce

speak(text):

Si hay audio reproduci√©ndose, stop antes de iniciar otro.

Debounce 1200ms para r√°fagas (m√∫ltiples eventos).

Respeta modo Pro/Ni√±o (Leo/Augusto) y idioma activo.

QA: no debe escucharse ‚Äúeco‚Äù ni overlapp.

6) API /api/stockfish/analyze (ya creada)

Mantener validaci√≥n Zod: fen (required), depth 1‚Äì20 (default 15).

Retornar { score, bestMove, depth }.

Manejar mate internamente como cualitativo (sin n√∫meros) en la explicaci√≥n.

7) Data-testids para E2E

A√±adir:

data-testid="board-canvas", "btn-first", "btn-prev", "btn-play", "btn-next", "btn-last",

"tab-analysis", "tab-moves", "tab-pgnbrowser", "game-select",

"btn-play-vs-coach", "play-color-select", "voice-toggle", "mode-segment-pro-kids".

8) Versionado/Cache

__APP_VERSION__ = "2025-11-01-fixpack-v4.1"

Bot√≥n ‚ÄúActualizar versi√≥n‚Äù que env√≠e SKIP_WAITING y recargue al controllerchange.

‚úÖ Criterios de aceptaci√≥n (no cerrar hasta cumplir)

PGN: al cargar, tablero en √∫ltima posici√≥n, contador full moves, navegaci√≥n operativa.

Play vs Coach (Negras): IA juega 1¬™ jugada de Blancas autom√°ticamente + AutoFlip; sin ‚Äúanalyzing forever‚Äù.

Selector color: accesible y testeable (Playwright).

Scroll: tablero + controles visibles sin scroll en 390√ó844; paneles con scroll interno.

Voz: sin superposici√≥n, con debounce.

Logs limpias y E2E verdes para los tres flujos: PGN, navegaci√≥n, Play vs Coach.

Commit √∫nico:
fix: v4.1 chess.com+ ‚Äî PGN sync, counter, play-vs-coach start, a11y, TTS single-channel, mobile dock