Aplica el **Cost Saver Pack v6.0 (Pro/Free + cache + low-cycles)** sin pedir confirmaciones.

OBJETIVO
- Mantener calidad PRO, bajar costos de GPT/voz y consumo de Cycles.
- Voz automÃ¡tica segÃºn plan (Pro=ElevenLabs, Free=gTTS/Piper), con cache y fallback.
- Limitar llamadas a GPT con memo por FEN y plantillas locales.

REGLAS DE COSTO (obligatorias)
- GPT: mÃ¡x 2 llamadas/min (burst 1 cada 3s). Si se excede â†’ plantilla local.
- Memo GPT: no llamar si hash(FEN|lang|mode|bestSan) existe (TTL 180â€“300s).
- Comentarios â‰¤200 caracteres, sin evaluaciones numÃ©ricas.
- TTS: cache LRU â‰¤200MB (clave=lang|mode|voice|sha256(text)). HEADâ†’reuseâ†’POST sÃ³lo si falta.
- Fallback TTS: si ElevenLabs falla o tarda >2s â†’ gTTS/Piper (mismo idioma), y cachear.
- Lazy-load de mÃ³dulos pesados (puzzles, pgn-browser, proveedores TTS); nada 24/7.

1) DETECCIÃ“N DE PLAN (Pro/Free) + BANNER
- Al cargar: leer `plan` de query (?plan=pro|free). Si no, usar cookie `planMode`; si no existe â†’ `free`.
- Guardar en cookie `planMode` (TTL 7d) + localStorage.
- VOICE_PROVIDER:
  - pro â†’ ELEVENLABS (IDs existentes por idioma/modo).
  - free â†’ GTTS o PIPER (elige el que estÃ© disponible en el proyecto).
- Banner fijo arriba:
  - Pro: â€œğŸ’ Modo Pro â€“ voz clonada del GM Leoâ€.
  - Free: â€œğŸ® Modo Gratis â€“ voz genÃ©rica (ahorro activado)â€.
- BotÃ³n â€œCambiarâ€ abre modal simple para alternar Pro/Free (sÃ³lo actualiza cookie y recarga voces).
- data-testid: plan-banner, plan-switch-pro, plan-switch-free.

2) GPT INTELIGENTE Y BARATO
- getGPTComment({fen,bestSan,scoreCp,motifs,phase,lang,mode}):
  - Primero memo por hash(FEN|lang|mode|bestSan). Si existe â†’ devolver memo.
  - isTrivialPosition(): si captura forzada, repeticiÃ³n, mate en 1â€“2, tÃ¡ctica evidente, libro de apertura â†’ plantilla local (sin GPT).
  - Si no trivial â†’ 1 llamada a GPT (perfil â€œDoctor en Entrenamiento AjedrecÃ­sticoâ€), respuesta â‰¤200 chars, sin nÃºmeros.
  - Guardar memo (TTL 180â€“300s).
- Debounce GPT 350â€“500ms.
- No re-analizar si FEN no cambiÃ³.

3) VOZ ASÃNCRONA + CACHE + FALLBACK
- speak(text, {lang,mode}):
  - Elegir proveedor por planMode (Pro=11L, Free=gTTS/Piper).
  - Generar clave cache `lang|mode|voice|sha256(text)`. Si hit â†’ reproducir instantÃ¡neo.
  - Si miss â†’ generar audio async (no bloquear UI), guardar y reproducir.
  - Al cambiar `language` o `mode` o `planMode` â†’ stop(), limpiar cola y reintentar con nueva voz.
  - Eliminar defaults en-US; respetar 100% `settings.language`.
- Debounce TTS 500â€“700ms.
- data-testid: tts-provider, tts-cache-hit.

4) INTEGRACIÃ“N CON LO YA HECHO (v5.1.1 + v5.3)
- Mantener botÃ³n **Importar** unificado (texto/archivo) con auto-detecciÃ³n PGN/FEN.
- PGN Browser en la derecha: Whiteâ€“Black Â· Result Â· ECO Â· Date (lista scrolleable).
- No disparar GPT al cambiar sÃ³lo de partida; disparar al cambiar FEN final/actual.
- Puzzles: mantener auto-next (400ms), persistir dificultad sin parpadeos.

5) SEGURIDAD LIGERA (sin migraciÃ³n)
- No exponer API keys en cliente; usar variables de entorno en backend.
- CORS: permitir sÃ³lo tu dominio principal + subdominio.
- CSP bÃ¡sica: default-src 'self'; connect-src 'self' *.elevenlabs.io TU_BACKEND; ajustar img/font segÃºn uso.
- Rate-limit por IP en /api/* (60/min). Logs sin PII.

6) E2E (rÃ¡pido)
- /?plan=pro â†’ banner Pro y VOZ=ElevenLabs; /?plan=free â†’ banner Free y VOZ=gTTS/Piper.
- Misma FEN repetida â†’ memo HIT (sin GPT). Misma frase â†’ TTS cache HIT (sin nueva llamada).
- Cambio idioma ES/PT/HI/EN â†’ voz y texto cambian; jamÃ¡s inglÃ©s si langâ‰ EN.
- Play vs Coach: negras â†’ engine mueve primero; blancas â†’ mueve usuario.
- Import: archivo .pgn mÃºltiple â†’ lista visible y carga a Ãºltima jugada; FEN pegado â†’ carga posiciÃ³n (sin agregar a lista).

MENSAJE Y COMMIT
- Imprime EXACTO:
âœ… Cost Saver Pack v6.0 aplicado: plan Pro/Free con voz auto (11L/gTTS/Piper), memo por FEN, rate-limit GPT, cache TTS con fallback, lazy-load, banner visible, bajo Cycles.
- Commit Ãºnico:
feat: v6.0 cost-saver (plan auto Pro/Free, GPT memo+rate-limit, TTS cache+fallback, lazy-load, banner)
